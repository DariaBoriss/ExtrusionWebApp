<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Исследователь</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #f4f7fa;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        h1, h2, h3 {
            color: #1e3c72;
        }

        .input-group {
            display: flex;
            gap: 12px;
            margin: 20px 0;
            flex-wrap: wrap;
            align-items: center;
        }

        select, input, button {
            padding: 12px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 6px;
        }

        select, input {
            flex: 1;
            min-width: 180px;
        }

        button {
            background: #00d4ff;
            color: white;
            border: none;
            cursor: pointer;
            min-width: 140px;
        }

            button:hover {
                background: #00aaff;
            }

        #downloadBtn {
            background: #28a745;
        }

            #downloadBtn:hover {
                background: #218838;
            }

        #error {
            color: #dc3545;
            font-weight: bold;
            margin: 10px 0;
            min-height: 24px;
        }

        .table-container {
            overflow-x: auto;
            margin: 25px 0;
            border: 1px solid #ddd;
            border-radius: 6px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 15px;
        }

        th, td {
            padding: 12px;
            text-align: center;
            border: 1px solid #ddd;
            min-width: 80px;
        }

        th {
            background: #1e3c72;
            color: white;
            position: sticky;
            left: 0;
            z-index: 1;
        }

            th:first-child, td:first-child {
                background: #f0f0f0;
                position: sticky;
                left: 0;
                z-index: 1;
            }

        .charts {
            display: flex;
            gap: 25px;
            flex-wrap: wrap;
            margin-top: 30px;
        }

        .chart-container {
            flex: 1;
            min-width: 420px;
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        canvas {
            height: 320px;
        }

        .note {
            font-size: 14px;
            color: #666;
            font-style: italic;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Исследование экструзии</h1>

        <div class="input-group">
            <select id="material"></select>
            <input id="minT" type="number" step="0.1" placeholder="T min, °C (100–250)">
            <input id="maxT" type="number" step="0.1" placeholder="T max, °C (100–250)">
            <input id="deltaT" type="number" step="0.1" placeholder="ΔT, °C (>0)">
            <input id="minGamma" type="number" step="1" placeholder="γ̇ min, с⁻¹ (1–1000)">
            <input id="maxGamma" type="number" step="1" placeholder="γ̇ max, с⁻¹ (1–1000)">
            <input id="deltaGamma" type="number" step="1" placeholder="Δγ̇, с⁻¹ (>0)">
            <button onclick="calculate()">Рассчитать</button>
            <button id="downloadBtn" onclick="downloadReport()">Скачать отчёт</button>
        </div>
        <div id="error"></div>

        <h2>Вязкость ƞ (Па·с) — все режимы</h2>
        <div class="table-container">
            <table id="table">
                <thead><tr><th>T \\ γ̇</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <div class="charts">
            <div class="chart-container">
                <h3>Зависимость вязкости от температуры при фиксированных скоростях сдвига</h3>
                <canvas id="chartT"></canvas>
                <div class="note">3 линии: мин, средняя и макс скорость сдвига</div>
            </div>
            <div class="chart-container">
                <h3>Зависимость вязкости от скорости сдвига при фиксированных температурах</h3>
                <canvas id="chartGamma"></canvas>
                <div class="note">3 линии: мин, средняя и макс температура</div>
            </div>
        </div>
    </div>

    <script>
        let chartT = null, chartGamma = null;
        let lastReportUrl = '';

        async function loadMaterials() {
            try {
                const res = await fetch('/api/materials');
                const data = await res.json();
                const select = document.getElementById('material');
                select.innerHTML = '<option value="">-- Выберите материал --</option>';
                data.forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m.id;
                    opt.textContent = m.name;
                    select.appendChild(opt);
                });
            } catch (err) {
                console.error('Ошибка загрузки материалов:', err);
                showError('Не удалось загрузить материалы');
            }
        }

        function showError(msg) {
            const error = document.getElementById('error');
            error.textContent = msg;
            setTimeout(() => error.textContent = '', 5000);
        }

        // ИСПРАВЛЕНО: УБРАН ДВОЙНОЙ RETURN
        function validate() {
            const materialId = document.getElementById('material').value;
            const minT = parseFloat(document.getElementById('minT').value);
            const maxT = parseFloat(document.getElementById('maxT').value);
            const deltaT = parseFloat(document.getElementById('deltaT').value);
            const minGamma = parseFloat(document.getElementById('minGamma').value);
            const maxGamma = parseFloat(document.getElementById('maxGamma').value);
            const deltaGamma = parseFloat(document.getElementById('deltaGamma').value);

            if (!materialId) return { valid: false, msg: 'Выберите материал' };
            if (isNaN(minT) || minT < 100 || minT > 250) return { valid: false, msg: 'T min: 100–250 °C' };
            if (isNaN(maxT) || maxT < 100 || maxT > 250 || minT >= maxT) return { valid: false, msg: 'T max: 100–250 °C, > min' };
            if (isNaN(deltaT) || deltaT <= 0) return { valid: false, msg: 'ΔT > 0' };
            if (isNaN(minGamma) || minGamma < 1 || minGamma > 1000) return { valid: false, msg: 'γ̇ min: 1–1000 с⁻¹' };
            if (isNaN(maxGamma) || maxGamma < 1 || maxGamma > 1000 || minGamma >= maxGamma) return { valid: false, msg: 'γ̇ max: 1–1000 с⁻¹, > min' };
            if (isNaN(deltaGamma) || deltaGamma <= 0) return { valid: false, msg: 'Δγ̇ > 0' };
            return { valid: true, data: { materialId: parseInt(materialId), minT, maxT, deltaT, minGamma, maxGamma, deltaGamma } };
        }

        async function calculate() {
            const v = validate();
            if (!v.valid) { showError(v.msg); return; }

            const { materialId, minT, maxT, deltaT, minGamma, maxGamma, deltaGamma } = v.data;

            try {
                const res = await fetch('/api/calculate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ materialId, minT, maxT, deltaT, minGamma, maxGamma, deltaGamma })
                });
                const data = await res.json();
                console.log("=== FULL DATA ===", data.full_data);
                console.log("FULL SERVER RESPONSE:", JSON.parse(JSON.stringify(data.full_data)));
                if (data.error) { showError(data.error); return; }

                lastReportUrl = data.report_url;
                const fd = data.full_data;

                // === ТАБЛИЦА ===
                const theadRow = document.querySelector('#table thead tr');
                theadRow.innerHTML = '<th>T \\ γ̇</th>';
                fd.gamma_range.forEach(g => {
                    const th = document.createElement('th');
                    th.textContent = `${parseFloat(g).toFixed(1)} с⁻¹`;
                    theadRow.appendChild(th);
                });

                const tbody = document.querySelector('#table tbody');
                tbody.innerHTML = '';
                fd.T_range.forEach(t => {
                    const tr = document.createElement('tr');
                    const tdT = document.createElement('td');
                    tdT.textContent = `${parseFloat(t).toFixed(1)} °C`;
                    tr.appendChild(tdT);

                    fd.gamma_range.forEach(g => {
                        const keyT = parseFloat(t).toFixed(1);
                        const keyG = parseFloat(g).toFixed(1);
                        const mu = fd.mu_table?.[keyT]?.[keyG];
                        const tdMu = document.createElement('td');
                        tdMu.textContent = mu !== undefined ? parseFloat(mu).toFixed(1) : '-';
                        tr.appendChild(tdMu);
                    });
                    tbody.appendChild(tr);
                });

                drawCharts(fd);
            } catch (err) {
                console.error(err);
                showError('Ошибка сервера');
            }
        }

        function drawCharts(fd) {
            const colors = ['#00d4ff', '#28a745', '#ff6b6b'];

            // === ГРАФИК μ(T) ===
            if (chartT) chartT.destroy();

            const labelsT = fd.T_range.map(t => Number(t).toFixed(1));

            const datasetsT = fd.G_points.map((g, i) => {
                const data = fd.mu_T[i] || [];  // ← теперь массив!

                return {
                    label: `γ̇ = ${Number(g).toFixed(1)} с⁻¹`,
                    data: data,
                    borderColor: colors[i % colors.length],
                    backgroundColor: colors[i % colors.length] + '33',
                    fill: false,
                    tension: 0.3
                };
            });

            chartT = new Chart(document.getElementById('chartT').getContext('2d'), {
                type: 'line',
                data: { labels: labelsT, datasets: datasetsT },
                options: {
                    responsive: true,
                    scales: {
                        x: { title: { display: true, text: 'Температура T (°C)' } },
                        y: { title: { display: true, text: 'Вязкость ƞ (Па·с)' }, beginAtZero: false }
                    }
                }
            });

            // === ГРАФИК μ(γ̇) ===
            if (chartGamma) chartGamma.destroy();

            const labelsG = fd.gamma_range.map(g => Number(g).toFixed(1));

            const datasetsG = fd.T_points.map((t, i) => {
                const data = fd.mu_gamma[i] || [];  // ← теперь массив!

                return {
                    label: `T = ${Number(t).toFixed(1)} °C`,
                    data: data,
                    borderColor: colors[i % colors.length],
                    backgroundColor: colors[i % colors.length] + '33',
                    fill: false,
                    tension: 0.3
                };
            });

            chartGamma = new Chart(document.getElementById('chartGamma').getContext('2d'), {
                type: 'line',
                data: { labels: labelsG, datasets: datasetsG },
                options: {
                    responsive: true,
                    scales: {
                        x: { type: 'logarithmic', title: { display: true, text: 'Скорость сдвига γ̇ (с⁻¹)' } },
                        y: { title: { display: true, text: 'Вязкость ƞ (Па·с)' }, beginAtZero: false }
                    }
                }
            });
        }
    

        function downloadReport() {
            if (lastReportUrl) {
                window.location.href = lastReportUrl;
            } else {
                alert('Сначала выполните расчёт');
            }
        }

        window.addEventListener('load', loadMaterials);
    </script>
</body>
</html>
